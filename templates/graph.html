<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚°ãƒ©ãƒ•è¡¨ç¤º</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
  /* çµ±è¨ˆè¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ */
  .stats-box {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
  }
  .stats-box h3 {
    margin-bottom: 1rem;
    font-weight: bold;
  }

  /* ã‚°ãƒ©ãƒ•è¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ */
  .graph-box {
    background-color: #ffffff;
    padding: 1rem;
    margin-bottom: 2rem;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.05);
  }
  .graph-box h3 {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    font-weight: bold;
  }

  /* è¡¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆBootstrapãŒæœ‰åŠ¹ãªå ´åˆï¼‰ */
  table.table {
    width: 100%;
    margin-top: 1rem;
  }

  /* æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ« */
  body {
    font-family: "Segoe UI", sans-serif;
    background-color: #f4f4f4;
    margin: 40px;
  }
  h1 {
    color: #333;
  }
  .section {
    margin-bottom: 40px;
    padding: 20px;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  .section h2 {
    margin-bottom: 10px;
    color: #0077cc;
  }
  .data-table {
    width: 100%;
    border-collapse: collapse;
  }
  .data-table th, .data-table td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
  }
  .back-link {
    display: inline-block;
    margin-top: 20px;
    text-decoration: none;
    color: #0077cc;
  }
  .save-button {
    margin-top: 10px;
  }
</style>

</head>
<body>
    <h1>ğŸ“Š ã‚°ãƒ©ãƒ•è¡¨ç¤º</h1>

    <div class="graph-box">
        <h2>ğŸ“ˆ ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ</h2>
        <form action="/graph" method="get" style="margin-bottom: 10px;">
            <label for="chart">ã‚°ãƒ©ãƒ•ç¨®é¡ï¼š</label>
            <select name="chart" id="chart">
                <option value="line">æŠ˜ã‚Œç·š</option>
                <option value="bar">æ£’ã‚°ãƒ©ãƒ•</option>
                <option value="scatter">æ•£å¸ƒå›³</option>
            </select>
            <input type="hidden" name="file" value="{{ request.args.get('file') }}">
            {% for symbol in request.args.getlist('symbol') %}
                <input type="hidden" name="symbol" value="{{ symbol }}">
            {% endfor %}
            <input type="hidden" name="start" value="{{ request.args.get('start') }}">
            <input type="hidden" name="end" value="{{ request.args.get('end') }}">
            <input type="hidden" name="price_min" value="{{ request.args.get('price_min') }}">
            <input type="hidden" name="price_max" value="{{ request.args.get('price_max') }}">
            <input type="hidden" name="action" value="{{ request.args.get('action') }}">
            <button type="submit">è¡¨ç¤ºåˆ‡æ›¿</button>
        </form>
        {{ latest_html|safe }}
        <form action="/save_png" method="get" class="save-button">
            <input type="hidden" name="chart" value="{{ request.args.get('chart', 'line') }}">
            <button type="submit">ğŸ“¥ ã‚°ãƒ©ãƒ•ã‚’PNGã§ä¿å­˜</button>
        </form>
    </div>

    <div class="graph-box">
        <h2>ğŸ§­ å††ã‚°ãƒ©ãƒ•</h2>
        {{ pie_html|safe }}
        <form action="/save_png" method="get" class="save-button">
            <input type="hidden" name="kind" value="pie">
            <button type="submit">ğŸ“¥ å††ã‚°ãƒ©ãƒ•ã‚’PNGä¿å­˜</button>
        </form>
    </div>

    <div class="graph-box"><h2>ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«</h2>{{ df_table|safe }}</div>
    <div class="graph-box"><h2>ğŸ“… æ—¥æ¬¡ã‚µãƒãƒªãƒ¼</h2>{{ daily_html|safe }}</div>
    <div class="graph-box"><h2>ğŸ“Š éŠ˜æŸ„çµ±è¨ˆ</h2>{{ stats_html|safe }}</div>
    <div class="graph-box"><h2>ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰æ¯”è¼ƒ</h2>{{ trend_html|safe }}</div>
    <div class="graph-box"><h2>ğŸ—“ï¸ æœˆæ¬¡ã‚µãƒãƒªãƒ¼</h2>{{ monthly_html|safe }}</div>
    <div class="graph-box"><h2>ğŸ“‰ ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>{{ volatility_html|safe }}</div>

    <div class="graph-box">
    <h2>ğŸ” æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
    <form action="/graph" method="get" id="filterForm">
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é …ç›® -->
        <label for="start">é–‹å§‹æ—¥:</label>
        <input type="date" id="start" name="start" value="{{ request.args.get('start', '') }}">
        <label for="end">çµ‚äº†æ—¥:</label>
        <input type="date" id="end" name="end" value="{{ request.args.get('end', '') }}">
        <label for="price_min">æœ€å°ä¾¡æ ¼:</label>
        <input type="number" id="price_min" name="price_min" value="{{ request.args.get('price_min', '') }}">
        <label for="price_max">æœ€å¤§ä¾¡æ ¼:</label>
        <input type="number" id="price_max" name="price_max" value="{{ request.args.get('price_max', '') }}">
        <label for="action">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</label>
        <select id="action" name="action">
            <option value="">é¸æŠãªã—</option>
            <option value="buy" {% if request.args.get('action') == 'buy' %}selected{% endif %}>è²·ã„</option>
            <option value="sell" {% if request.args.get('action') == 'sell' %}selected{% endif %}>å£²ã‚Š</option>
        </select>
        {% for symbol in request.args.getlist('symbol') %}
            <input type="hidden" name="symbol" value="{{ symbol }}">
        {% endfor %}
        <input type="hidden" name="file" value="{{ request.args.get('file', '') }}">
        <input type="hidden" name="chart" value="{{ request.args.get('chart', 'line') }}">
        <button type="submit">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨</button>
    </form>

    <!-- åå‰ä»˜ãä¿å­˜ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="named-save">
        <label for="filterName">ä¿å­˜åï¼š</label>
        <input type="text" id="filterName" placeholder="ä¾‹: ETHåˆ†æ" list="filterList">
        <button onclick="saveFilterAs()">ğŸ’¾ åå‰ä»˜ãä¿å­˜</button>
        <button onclick="loadFilterByName()">ğŸ“‚ åå‰ä»˜ãèª­è¾¼</button>
    </div>

    <!-- ä¸€è¦§è¡¨ç¤ºç”¨ datalistï¼ˆæ¬¡ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ã†ï¼‰ -->
    <datalist id="filterList"></datalist>

    <div class="filter-actions">
        <button onclick="saveFilter()">ğŸ’¾ é€šå¸¸ä¿å­˜</button>
        <button onclick="loadFilter()">ğŸ“‚ é€šå¸¸èª­è¾¼</button>
    </div>
</div>
    <div class="stats-box mt-4">
  <h3>ğŸ“Š ã‚·ã‚°ãƒŠãƒ«çµ±è¨ˆ</h3>
  <table class="table table-bordered table-sm table-striped">
    <thead><tr><th>é …ç›®</th><th>å€¤</th></tr></thead>
    <tbody>
      {% for key, value in signal_stats.items() %}
        <tr><td>{{ key }}</td><td>{{ value }}</td></tr>
      {% endfor %}
    </tbody>
    </table>
    </div>

    <div class="graph-box">
        <h2>ğŸ“Š ç§»å‹•å¹³å‡ãƒãƒ£ãƒ¼ãƒˆ</h2>
        {{ ma_html|safe }}
        <form action="/save_png" method="get" class="save-button">
            <input type="hidden" name="kind" value="ma">
            <button type="submit">ğŸ“¥ ç§»å‹•å¹³å‡ãƒãƒ£ãƒ¼ãƒˆã‚’PNGä¿å­˜</button>
        </form>
    </div>

    <div class="graph-box">
        <h2>ğŸ“ˆ RSIãƒ»MACDãƒãƒ£ãƒ¼ãƒˆ</h2>
        {{ rsi_macd_html|safe }}
        <!-- âœ… å£²è²·ã‚·ã‚°ãƒŠãƒ«CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ -->
<h4>ğŸ“¥ å£²è²·ã‚·ã‚°ãƒŠãƒ«CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h4>
<a href="{{ url_for('static', filename='buy_signals.csv') }}" download>ğŸ“¥ è²·ã„ã‚·ã‚°ãƒŠãƒ«CSV</a><br>
<a href="{{ url_for('static', filename='sell_signals.csv') }}" download>ğŸ“¥ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«CSV</a>
<h4>ğŸ‘€ è²·ã„ã‚·ã‚°ãƒŠãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
{{ buy_table_html|safe }}

<h4>ğŸ‘€ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
{{ sell_table_html|safe }}
        <form action="/save_signals" method="get" class="save-button">
            <button type="submit">ğŸ“¥ RSIãƒ»MACDã‚·ã‚°ãƒŠãƒ«ã‚’CSVä¿å­˜</button>
        </form>
    </div>

    <h3>ğŸ“Š å£²è²·ã‚·ã‚°ãƒŠãƒ«çµ±è¨ˆ</h3>
<table class="table table-bordered">
  <tr><th>é …ç›®</th><th>å€¤</th></tr>
  {% for key, value in signal_stats.items() %}
    <tr><td>{{ key }}</td><td>{{ value }}</td></tr>
  {% endfor %}
</table>

    <a href="/" class="back-link">â† æˆ»ã‚‹</a>

    <script>
    function saveFilter() {
        const form = document.getElementById('filterForm');
        const filter = {
            start: form.start.value,
            end: form.end.value,
            price_min: form.price_min.value,
            price_max: form.price_max.value,
            action: form.action.value,
            symbol: Array.from(form.querySelectorAll('input[name="symbol"]')).map(e => e.value),
            file: form.file.value,
            chart: form.chart.value
        };
        localStorage.setItem('savedFilter', JSON.stringify(filter));
        alert("ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    }

    function loadFilter() {
        const filter = JSON.parse(localStorage.getItem('savedFilter'));
        if (!filter) {
            alert("ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        const form = document.getElementById('filterForm');
        form.start.value = filter.start || '';
        form.end.value = filter.end || '';
        form.price_min.value = filter.price_min || '';
        form.price_max.value = filter.price_max || '';
        form.action.value = filter.action || '';

        form.querySelectorAll('input[name="symbol"]').forEach(e => e.remove());
        if (Array.isArray(filter.symbol)) {
            filter.symbol.forEach(sym => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'symbol';
                input.value = sym;
                form.appendChild(input);
            });
        }

        form.file.value = filter.file || '';
        form.chart.value = filter.chart || 'line';

        alert("ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
    }
    </script>
<script>
function saveFilterAs() {
    const name = document.getElementById('filterName').value.trim();
    if (!name) {
        alert("ä¿å­˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
        return;
    }

    const form = document.getElementById('filterForm');
    const filter = {
        start: form.start.value,
        end: form.end.value,
        price_min: form.price_min.value,
        price_max: form.price_max.value,
        action: form.action.value,
        symbol: Array.from(form.querySelectorAll('input[name="symbol"]')).map(e => e.value),
        file: form.file.value,
        chart: form.chart.value
    };

    localStorage.setItem(`savedFilter_${name}`, JSON.stringify(filter));
    alert(`ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);

    const datalist = document.getElementById('filterList');
    if (![...datalist.options].some(opt => opt.value === name)) {
        const option = document.createElement('option');
        option.value = name;
        datalist.appendChild(option);
    }
}
</script>

<script>
function loadFilterByName() {
    const name = document.getElementById('filterName').value.trim();
    if (!name) {
        alert("ä¿å­˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
        return;
    }

    const filter = JSON.parse(localStorage.getItem(`savedFilter_${name}`));
    if (!filter) {
        alert(`ã€Œ${name}ã€ã¨ã„ã†ä¿å­˜åã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
        return;
    }

    const form = document.getElementById('filterForm');
    form.start.value = filter.start || '';
    form.end.value = filter.end || '';
    form.price_min.value = filter.price_min || '';
    form.price_max.value = filter.price_max || '';
    form.action.value = filter.action || '';

    form.querySelectorAll('input[name="symbol"]').forEach(e => e.remove());
    if (Array.isArray(filter.symbol)) {
        filter.symbol.forEach(sym => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'symbol';
            input.value = sym;
            form.appendChild(input);
        });
    }

    form.file.value = filter.file || '';
    form.chart.value = filter.chart || 'line';

    alert(`ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€Œ${name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼`);
    localStorage.setItem('lastUsedFilter', name); // âœ… æ­£ã—ã„ä½ç½®
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const datalist = document.getElementById('filterList');

    // datalistã«ä¿å­˜æ¸ˆã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åã‚’è¿½åŠ 
    for (let key in localStorage) {
        if (key.startsWith('savedFilter_')) {
            const name = key.replace('savedFilter_', '');
            if (![...datalist.options].some(opt => opt.value === name)) {
                const option = document.createElement('option');
                option.value = name;
                datalist.appendChild(option);
            }
        }
    }

    // å‰å›ä½¿ç”¨ã—ãŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è‡ªå‹•èª­è¾¼
    const lastUsed = localStorage.getItem('lastUsedFilter');
    if (lastUsed) {
        document.getElementById('filterName').value = lastUsed;
        loadFilterByName(); // âœ… å¼•æ•°ãªã—ã§OK
    }
});
</script>
</body>
</html>